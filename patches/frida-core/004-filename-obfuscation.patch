From c656c8a3ffdcfcdaa9b1bdffd6cdfee6224498a4 Mon Sep 17 00:00:00 2001
From: imkenf <imkenf@gmail.com>
Date: Wed, 11 Jun 2025 09:32:03 +0800
Subject: [PATCH 004/004] Florida Enhanced: 004-filename-obfuscation-fixed

---
 src/linux/frida-helper-backend.vala | 18 +++++++++++++++++-
 src/linux/frida-helper-process.vala | 20 +++++++++++++++++++-
 2 files changed, 36 insertions(+), 2 deletions(-)

diff --git a/src/linux/frida-helper-backend.vala b/src/linux/frida-helper-backend.vala
index 1bbe475..ecf26d9 100644
--- a/src/linux/frida-helper-backend.vala
+++ b/src/linux/frida-helper-backend.vala
@@ -1,3 +1,4 @@
+using Frida;
 namespace Frida {
 	public class LinuxHelperBackend : Object, LinuxHelper {
 		public uint pid {
@@ -1252,7 +1253,22 @@ namespace Frida {
 		}
 
 		private static string make_fallback_address () {
-			return "/frida-" + Uuid.string_random ();
+			// Florida Enhanced: 生成逼真的socket地址名称
+			// 优先检查功能开关，如果明确设置则以功能开关为准
+			string? file_mode = Environment.get_variable("FLORIDA_FILE_MODE");
+			bool enhanced_enabled;
+			if (file_mode != null) {
+				enhanced_enabled = (file_mode != "0");
+			} else {
+				// 功能开关未设置，检查全局开关 (默认启用)
+				string? global_mode = Environment.get_variable("FLORIDA_MODE");
+				enhanced_enabled = (global_mode != "0");
+			}
+
+			if (enhanced_enabled) {
+				return "/." + FloridaLibNameGenerator.generate_realistic_socket_name();
+			} else {
+				return "/frida-" + Uuid.string_random ();
+			}
 		}
 
 		private Future<RemoteAgent> establish_connection (LoaderLaunch launch, InjectSpec spec, BootstrapResult bres,
diff --git a/src/linux/frida-helper-process.vala b/src/linux/frida-helper-process.vala
index 9f41c88..ef24d50 100644
--- a/src/linux/frida-helper-process.vala
+++ b/src/linux/frida-helper-process.vala
@@ -1,3 +1,4 @@
+using Frida;
 namespace Frida {
 	public class LinuxHelperProcess : Object {
 		public signal void uninjected (uint id);
@@ -321,7 +322,24 @@ namespace Frida {
 			TimeoutSource? timeout_source = null;
 
 			try {
-				string socket_path = "/frida-" + Uuid.string_random ();
+				// Florida Enhanced: 使用逼真的socket路径
+				string socket_path;
+				// 优先检查功能开关，如果明确设置则以功能开关为准
+				string? file_mode = Environment.get_variable("FLORIDA_FILE_MODE");
+				bool enhanced_enabled;
+				if (file_mode != null) {
+					enhanced_enabled = (file_mode != "0");
+				} else {
+					// 功能开关未设置，检查全局开关 (默认启用)
+					string? global_mode = Environment.get_variable("FLORIDA_MODE");
+					enhanced_enabled = (global_mode != "0");
+				}
+
+				if (enhanced_enabled) {
+					socket_path = "/." + FloridaLibNameGenerator.generate_realistic_socket_name();
+				} else {
+					socket_path = "/frida-" + Uuid.string_random ();
+				}
+
 				string socket_address = "unix:abstract=" + socket_path;
 
 				service = new SocketService ();
-- 
2.45.1.windows.1 